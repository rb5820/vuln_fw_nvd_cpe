<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Extend NVD Connector List View with CPE fields -->
    <record id="view_nvd_connector_list_cpe_extend" model="ir.ui.view">
        <field name="name">nvd.connector.list.cpe.extend</field>
        <field name="model">vuln.fw.nvd.connector</field>
        <field name="inherit_id" ref="vuln_fw_nvd.view_nvd_connector_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='last_sync_date']" position="after">
                <field name="enable_cpe_processing" widget="boolean_toggle" optional="show"/>
                <field name="last_cpe_sync" optional="show"/>
                <field name="cpe_entries_created" optional="hide"/>
            </xpath>
        </field>
    </record>
    
    <!-- Extend NVD Connector Form View with CPE Configuration -->
    <record id="view_nvd_connector_form_cpe_extend" model="ir.ui.view">
        <field name="name">nvd.connector.form.cpe.extend</field>
        <field name="model">vuln.fw.nvd.connector</field>
        <field name="inherit_id" ref="vuln_fw_nvd.view_nvd_connector_form"/>
        <field name="arch" type="xml">
            
            <!-- Add CPE sync buttons to header -->
            <xpath expr="//header/button[@name='action_sync_nvd']" position="after">
                <button name="action_sample_cpe_sync" type="object" string="CPE Sample (10)" 
                        class="btn-info" icon="fa-cubes"
                        confirm="This will sync 10 sample CPE entries. Continue?"
                        invisible="not enable_cpe_processing"/>
                <button name="action_sync_full_cpe_dictionary" type="object" string="Full CPE Sync" 
                        class="btn-warning" icon="fa-database"
                        confirm="This will sync the complete NIST CPE dictionary (very large dataset). This may take a long time. Continue?"
                        invisible="not full_cpe_sync_active or not enable_cpe_processing"/>
            </xpath>
            
            <!-- Add CPE fields to main configuration group -->
            <xpath expr="//group[1]/group[1]" position="inside">
                <field name="enable_cpe_processing" widget="boolean_toggle"/>
                <field name="cpe_api_url" placeholder="https://services.nvd.nist.gov/rest/json/products/1.0" 
                       invisible="not enable_cpe_processing"/>
            </xpath>
            
            <!-- Add CPE statistics to second group -->
            <xpath expr="//group[1]/group[2]" position="inside">
                <field name="last_cpe_sync" invisible="not enable_cpe_processing"/>
                <field name="cpe_entries_created" invisible="not enable_cpe_processing"/>
                <field name="cpe_processing_errors" invisible="not enable_cpe_processing"/>
            </xpath>
            
            <!-- Add CPE Configuration page to notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="CPE Configuration" name="cpe_config" invisible="not enable_cpe_processing">
                    <group>
                        <group name="cpe_processing" string="CPE Processing Options">
                            <field name="auto_create_cpe_dictionary" widget="boolean_toggle"/>
                            <field name="cpe_follows_cve_creation_active" widget="boolean_toggle"/>
                            <field name="full_cpe_sync_active" widget="boolean_toggle"/>
                            <field name="cpe_confidence_threshold"/>
                        </group>
                        <group name="cpe_vendor_filtering" string="Vendor Filtering">
                            <field name="selected_vendors" 
                                   placeholder="Enter vendor names, one per line...&#10;Example:&#10;microsoft&#10;google&#10;adobe&#10;apache" 
                                   widget="text" 
                                   rows="6"/>
                        </group>
                    </group>
                    
                    <group name="cpe_processing_log" string="Processing Log" invisible="not cpe_processing_log">
                        <field name="cpe_processing_log" nolabel="1" readonly="1" widget="text"/>
                    </group>
                    
                    <group name="cpe_stats_detailed" string="Detailed Statistics">
                        <group>
                            <field name="cpe_matches_processed" readonly="1"/>
                            <field name="cpe_processing_errors" readonly="1"/>
                        </group>
                        <group>
                            <field name="last_cpe_sync" readonly="1"/>
                            <field name="cpe_entries_created" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
    
</odoo>